# 标签系统文件存储迁移方案

## 一、迁移目标
将标签系统的所有数据（包括基本信息、展开关系、引用关系、图片关联等）从Room数据库迁移到文件系统，每个标签对应一个独立的JSON文件，存储在公共配置目录中。

## 二、文件结构设计
```
/storage/emulated/0/YuMoBox/
├── config/             # 应用配置文件
└── tags/               # 标签数据文件目录
    ├── tag_1.json      # 标签1的数据
    ├── tag_2.json      # 标签2的数据
    ├── tag_3.json      # 标签3的数据
    └── ...
```

## 三、标签JSON数据结构
```json
{
  "id": 1,
  "parentId": null,
  "name": "风景",
  "sortOrder": 0,
  "referencedGroupSortOrder": 0,
  "normalGroupSortOrder": 0,
  "isExpanded": true,
  "imageCount": 5,
  "directImageCount": 3,
  "totalImageCount": 5,
  "referencedCount": 2,
  "mediaPaths": [
    "/storage/emulated/0/DCIM/photo1.jpg",
    "/storage/emulated/0/DCIM/photo2.jpg",
    "/storage/emulated/0/DCIM/photo3.jpg"
  ],
  "referencedTags": [
    {
      "childTagId": 2,
      "sortOrder": 0
    },
    {
      "childTagId": 3,
      "sortOrder": 1
    }
  ],
  "parentReferences": [
    {
      "parentTagId": 4,
      "sortOrder": 0
    }
  ]
}
```

## 四、迁移步骤

### 1. 创建标签文件管理核心类
- 创建 `TagFileManager.kt`，负责标签数据的文件读写
- 实现标签JSON的序列化和反序列化
- 提供标签数据的增删改查接口

### 2. 设计标签数据模型
- 创建 `TagData.kt`，定义标签完整数据结构
- 包含标签基本信息、媒体关联、引用关系等

### 3. 实现数据迁移逻辑
- 创建 `TagDataMigration.kt`，负责从数据库迁移到文件
- 读取现有数据库中的所有标签数据
- 转换为JSON格式并写入文件
- 提供迁移状态跟踪和验证

### 4. 修改标签操作逻辑
- 替换 `TagRepository` 的实现，使用文件存储
- 修改 `TagViewModel` 等相关类，使用新的文件存储接口
- 实现标签的创建、删除、重命名等功能
- 实现标签与媒体的关联管理
- 实现标签引用关系管理

### 5. 更新应用启动流程
- 在应用启动时执行标签数据迁移
- 验证迁移结果
- 切换到文件存储模式

## 五、核心功能实现

### 1. 标签文件管理
```kotlin
object TagFileManager {
    // 获取标签数据文件
    fun getTagFile(tagId: Long): File
    
    // 读取标签数据
    fun readTag(tagId: Long): TagData?
    
    // 写入标签数据
    fun writeTag(tagData: TagData): Boolean
    
    // 删除标签数据
    fun deleteTag(tagId: Long): Boolean
    
    // 获取所有标签数据
    fun getAllTags(): List<TagData>
    
    // 查找标签数据
    fun findTagByName(name: String): TagData?
}
```

### 2. 标签数据迁移
```kotlin
object TagDataMigration {
    // 执行数据迁移
    fun migrateFromDatabase(context: Context): Boolean
    
    // 验证迁移结果
    fun verifyMigration(): Boolean
    
    // 清理数据库数据（可选）
    fun cleanupDatabase(context: Context): Boolean
}
```

### 3. 标签操作接口
```kotlin
interface TagRepository {
    // 标签基本操作
    suspend fun createTag(name: String, parentId: Long? = null): Long
    suspend fun renameTag(id: Long, newName: String, parentId: Long? = null)
    suspend fun deleteTag(id: Long)
    
    // 媒体关联操作
    suspend fun addTagToMedia(mediaPath: String, tagId: Long)
    suspend fun removeTagFromMedia(mediaPath: String, tagId: Long)
    
    // 引用关系操作
    suspend fun addTagReference(parentTagId: Long, childTagId: Long): Boolean
    suspend fun removeTagReference(parentTagId: Long, childTagId: Long)
    
    // 标签数据查询
    fun observeRootTags(): Flow<List<TagWithChildren>>
    suspend fun getDescendantTagIds(tagId: Long): List<Long>
    suspend fun getMediaPathsByAnyTag(tagIds: List<Long>): List<String>
}
```

## 六、迁移注意事项

1. **数据完整性**：确保迁移过程中不丢失任何标签数据
2. **性能优化**：实现标签数据的缓存机制，提高频繁访问的性能
3. **并发安全**：处理多线程读写标签文件的情况
4. **向后兼容**：保留数据库访问接口，支持回滚
5. **错误恢复**：实现数据备份和恢复机制
6. **迁移状态**：提供迁移进度和结果反馈

## 七、实施步骤

1. **设计阶段**：完成标签数据JSON结构设计
2. **开发阶段**：实现文件存储管理、数据迁移和标签操作逻辑
3. **测试阶段**：验证迁移功能和标签操作功能
4. **部署阶段**：集成到应用中，执行数据迁移
5. **监控阶段**：监控迁移后系统的性能和稳定性

## 八、预期效果

1. **更灵活的数据管理**：支持手动编辑标签数据文件
2. **更方便的数据迁移**：便于用户备份和恢复标签数据
3. **更好的跨设备支持**：支持标签数据的导入导出
4. **更清晰的数据结构**：每个标签数据独立存储，便于管理
5. **更强的可扩展性**：便于添加新的标签属性和功能

通过这个方案，我们可以将标签系统的数据从数据库迁移到文件系统，满足用户的需求，同时保持系统的性能和稳定性。