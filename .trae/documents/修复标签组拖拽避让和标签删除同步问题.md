## 问题分析

### 问题1：拖拽避让效果bug
- **当前问题**：拖拽过程中更换位置会导致拖拽立刻终止
- **根本原因**：在`onDrag`回调中实时更新标签组顺序，导致`draggedItemIndex`不断变化，影响拖拽连续性
- **预期行为**：拖拽过程中其他标签组自动避让，只有用户松开手指时才结束拖拽并更新最终位置

### 问题2：标签删除与标签组不同步
- **当前问题**：删除标签时，标签组的数据不会同步删除该标签引用
- **根本原因**：删除标签的逻辑没有处理标签组中对该标签的引用
- **预期行为**：删除标签时，自动从所有标签组中移除该标签的引用

## 修复计划

### 修复1：拖拽避让效果优化
1. **修改拖拽逻辑**：将标签组顺序更新从`onDrag`回调移至`onDragEnd`回调
2. **保留实时位置计算**：在拖拽过程中仍然计算实时位置，实现避让效果
3. **优化位置计算**：确保拖拽过程中位置计算准确，避免抖动
4. **修复拖拽终止问题**：确保拖拽过程中`draggedItemIndex`保持稳定

### 修复2：标签删除与标签组同步
1. **添加标签删除监听器**：在标签删除时触发标签组同步逻辑
2. **遍历所有标签组**：删除标签时，遍历所有标签组文件
3. **移除标签引用**：从每个标签组中移除被删除标签的ID
4. **更新标签组文件**：将更新后的标签组数据写回文件系统

## 实现步骤

### 步骤1：修复拖拽避让效果
1. 修改`TagGroupNavigationBar.kt`中的拖拽逻辑
2. 在`onDrag`中只更新拖拽偏移量，不更新标签组顺序
3. 在`onDragEnd`中计算最终位置并更新标签组顺序
4. 优化位置计算算法，确保准确匹配网格位置

### 步骤2：实现标签删除与标签组同步
1. 修改`TagCrudManager.kt`中的删除标签方法
2. 添加标签组同步逻辑
3. 调用`TagGroupFileManager`的方法移除标签引用
4. 确保同步操作在后台线程执行，不阻塞UI

## 关键代码修改

### 文件1：`TagGroupNavigationBar.kt`
- 修改`detectDragGesturesAfterLongPress`的回调逻辑
- 优化`onDrag`和`onDragEnd`方法

### 文件2：`TagCrudManager.kt`
- 在`deleteTag`和`deleteTagWithUndo`方法中添加标签组同步

### 文件3：`TagGroupFileManager.kt`
- 添加`removeTagFromAllTagGroups`方法，用于从所有标签组中移除标签引用

## 预期效果

1. **拖拽避让效果**：拖拽过程中标签组平滑避让，拖拽结束后才更新最终顺序
2. **拖拽连续性**：拖拽过程中不会突然终止，跟随手指流畅移动
3. **标签删除同步**：删除标签后，所有标签组自动移除该标签引用
4. **数据一致性**：标签组数据与标签数据保持一致，避免残留引用

## 测试要点

1. **拖拽测试**：测试标签组拖拽过程中的流畅性和避让效果
2. **删除标签测试**：删除标签后检查所有标签组是否移除了该标签引用
3. **创建标签测试**：删除标签后创建同名标签，检查是否会自动添加到标签组
4. **性能测试**：测试大量标签组情况下的同步性能

## 风险评估

- **性能风险**：遍历大量标签组可能影响性能，需在后台线程执行
- **数据一致性风险**：需确保标签组更新的原子性，避免数据损坏
- **兼容性风险**：修改拖拽逻辑可能影响现有拖拽体验，需充分测试

## 依赖关系

- 依赖`TagGroupFileManager`的文件操作能力
- 依赖`crudManager`的标签删除流程
- 依赖`coroutineScope`进行后台线程操作